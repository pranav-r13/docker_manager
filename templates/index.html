<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenCTI Manager</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Bootstrap JS (Loaded early for Modal init) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            background-color: #1a1d20;
            color: #d1d5db;
        }

        .card {
            background-color: #212529;
            border-color: #374151;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .terminal-window {
            background-color: #0d1117;
            color: #58a6ff;
            font-family: 'Courier New', Courier, monospace;
            height: 400px;
            overflow-y: auto;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 10px;
            white-space: pre-wrap;
            font-size: 0.9em;
        }

        .status-dot {
            height: 10px;
            width: 10px;
            background-color: #bbb;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-online {
            background-color: #2ea043;
        }

        .status-offline {
            background-color: #da3633;
        }

        .status-warning {
            background-color: #dbab09;
        }

        .progress {
            background-color: #374151;
        }

        .nav-tabs .nav-link {
            color: #d1d5db;
        }

        .nav-tabs .nav-link.active {
            background-color: #212529;
            color: #fff;
            border-color: #dee2e6 #dee2e6 #212529;
        }
    </style>
</head>

<body class="p-4">

    <div class="container-fluid" style="max-width: 1400px;">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-shield-lock-fill text-primary"></i> CTI Platform Manager</h1>
            <div>
                <a href="http://192.168.0.205:8080" class="btn btn-outline-primary btn-sm" tabindex="-1" role="button"
                    target="_blank"><i class="bi bi-bullseye"></i> OpenCTI</a>
                <a href="https://192.168.0.204" class="btn btn-outline-secondary btn-sm" tabindex="-1" role="button"
                    target="_blank"><i class="bi bi-crosshair"></i> MISP</a>

                <button class="btn btn-outline-warning btn-sm" id="connection-status" disabled><span
                        class="status-dot"></span>
                    Connecting... </button>

                <!-- <a id="connection-status" class="badge bg-secondary"><span
                        class="status-dot"></span>Connecting...</span> -->

            </div>
        </div>

        <!-- Main Navigation Tabs -->
        <ul class="nav nav-tabs mb-3" id="mainTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard-pane"
                    type="button" role="tab" aria-selected="true"><i class="bi bi-speedometer2"></i> Dashboard</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="controls-tab" data-bs-toggle="tab" data-bs-target="#controls-pane"
                    type="button" role="tab" aria-selected="false"><i class="bi bi-sliders"></i> Platform
                    Controls</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="containers-tab" data-bs-toggle="tab" data-bs-target="#containers-pane"
                    type="button" role="tab" aria-selected="false"><i class="bi bi-box-seam"></i> Running
                    Containers</button>
            </li>
        </ul>

        <div class="tab-content" id="mainTabContent">

            <!-- DASHBOARD TAB -->

            <div class="tab-pane fade show active" id="dashboard-pane" role="tabpanel">
                <h4 class="mb-3 text-warning"><i class="bi bi-memory"></i> System Metrics</h4>
                <!-- System Stats ROW -->
                <!-- System Stats ROW -->
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="card bg-dark border-secondary h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="card-title text-muted text-uppercase m-0"><i class="bi bi-cpu"></i> CPU
                                        Usage</h6>
                                    <span class="badge bg-dark border border-secondary text-muted" id="avg-cpu">Avg:
                                        --</span>
                                </div>
                                <h5 class="fw-bold" id="cpu-val">0%</h5>
                                <div class="progress mb-3" style="height: 5px;">
                                    <div class="progress-bar bg-info" id="cpu-bar" style="width: 0%"></div>
                                </div>
                                <!-- Chart -->
                                <div style="height: 150px;"><canvas id="hist-cpu"></canvas></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-dark border-secondary h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="card-title text-muted text-uppercase m-0"><i class="bi bi-memory"></i>
                                        RAM Usage</h6>
                                    <span class="badge bg-dark border border-secondary text-muted" id="avg-ram">Avg:
                                        --</span>
                                </div>
                                <h5 class=" fw-bold" id="ram-val">0%</h5>
                                <div class="progress mb-3" style="height: 5px;">
                                    <div class="progress-bar bg-warning" id="ram-bar" style="width: 0%"></div>
                                </div>
                                <!-- Chart -->
                                <div style="height: 150px;"><canvas id="hist-ram"></canvas></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-dark border-secondary h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="card-title text-muted text-uppercase m-0"><i class="bi bi-hdd"></i> Disk
                                        Usage</h6>
                                    <span class="badge bg-dark border border-secondary text-muted" id="avg-disk">Avg:
                                        --</span>
                                </div>
                                <h5 class="fw-bold" id="disk-val">0%</h5>
                                <div class="progress mb-3" style="height: 5px;">
                                    <div class="progress-bar bg-danger" id="disk-bar" style="width: 0%"></div>
                                </div>
                                <!-- Chart -->
                                <div style="height: 150px;"><canvas id="hist-disk"></canvas></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mb-3 mt-3">
                    <div class="col-md-3">
                        <div class="card p-3">
                            <label>Network Sent/Recv</label>
                            <div class="d-flex justify-content-between mt-1">
                                <small class="text-muted">Down: <span id="net-in">0</span> KB/s</small>
                                <small class="text-muted">Up: <span id="net-out">0</span> KB/s</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RabbitMQ Stats -->
                <h4 class="mb-3 text-warning"><i class="bi bi-envelope-paper"></i> RabbitMQ Metrics</h4>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="card p-3 text-center">
                            <h6 class="text-muted mb-2">Status</h6>
                            <h3 id="mq-status" class="mb-0"><span class="badge bg-secondary">Unknown</span></h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card p-3 text-center">
                            <h6 class="text-muted mb-2">Bundles Queueud</h6>
                            <h3 id="mq-queued" class="text-light mb-0">0</h3>
                            <small class="text-muted">Messages Ready</small>
                            <div style="height: 60px; width: 100%; margin-top: 10px;">
                                <canvas id="chart-queued"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card p-3 text-center">
                            <h6 class="text-muted mb-2">Bundles Processed/Total</h6>
                            <h3 id="mq-total" class="text-light mb-0">0</h3>
                            <small class="text-muted">Total Messages</small>
                            <div style="height: 60px; width: 100%; margin-top: 10px;">
                                <canvas id="chart-total"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card p-3 text-center">
                            <h6 class="text-muted mb-2">Rate (In / Out)</h6>
                            <div class="mb-0">
                                <div><span class="text-success" id="mq-rate-in">0.0</span> <small>/s In</small></div>
                                <div><span class="text-info" id="mq-rate-out">0.0</span> <small>/s Out</small></div>
                            </div>
                            <div style="height: 60px; width: 100%; margin-top: 10px;">
                                <canvas id="chart-rate"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONTROLS TAB -->
            <div class="tab-pane fade" id="controls-pane" role="tabpanel">
                <div class="row">
                    <!-- Control Panel -->
                    <div class="col-md-6">
                        <h4 class="mb-3">Deployment Management</h4>

                        <!-- Core Platform -->
                        <div class="card mb-3">
                            <div
                                class="card-header fw-bold text-uppercase text-light border-secondary d-flex justify-content-between">
                                <span><i class="bi bi-hdd-stack"></i> Core Platform</span>
                                <span id="status-core" class="badge bg-secondary">Checking...</span>
                            </div>
                            <div class="card-body d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>~/opencti/docker</strong>
                                    <div class="text-muted small mt-1">Main OpenCTI Stack</div>
                                </div>
                                <div>
                                    <button class="btn btn-primary me-2" onclick="sendAction('core', 'up')"><i
                                            class="bi bi-play-fill"></i> Start</button>
                                    <button class="btn btn-danger" onclick="sendAction('core', 'down')"><i
                                            class="bi bi-stop-fill"></i> Stop</button>
                                </div>
                            </div>
                        </div>

                        <!-- Connectors -->
                        <h5 class="mt-4 mb-3">Connectors <button class="btn btn-sm btn-outline-info float-end"
                                onclick="location.reload()"><i class="bi bi-arrow-clockwise"></i> Refresh</button></h5>
                        <div class="row g-3" id="connectors-list">
                            <!-- Populated dynamically via Socket.IO -->
                            <div class="col-12 text-center text-muted p-3" id="connectors-loading">Scanning for
                                connectors...</div>
                        </div>
                    </div>

                    <!-- Terminal Output (Shared for Controls) -->
                    <div class="col-md-6">
                        <h4 class="mb-3">Live Log Console <small class="text-muted fs-6 fw-normal">(Streams
                                Output)</small></h4>
                        <div id="terminal" class="terminal-window">
                            <div class="text-muted">// Ready for commands...</div>
                        </div>
                        <div class="mt-2 text-end">
                            <button class="btn btn-sm btn-outline-secondary" onclick="clearTerminal()">Clear
                                Console</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RUNNING CONTAINERS TAB -->
            <div class="tab-pane fade" id="containers-pane" role="tabpanel">
                <h4 class="mb-3">Live Container List</h4>
                <div class="table-responsive">
                    <table class="table table-dark table-hover table-sm">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Image</th>
                                <th>Status</th>
                                <th>Uptime</th>
                            </tr>
                        </thead>
                        <tbody id="containers-table-body">
                            <tr>
                                <td colspan="5" class="text-center text-muted">Waiting for updates...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    </div>

    <!-- Password Modal -->
    <div class="modal fade" id="passwordModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content bg-dark border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Enter Password</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="password" id="unlock-password" class="form-control" placeholder="Password">
                    <div id="password-error" class="text-danger small mt-2"></div>
                </div>
                <div class="modal-footer border-secondary p-1">
                    <button type="button" class="btn btn-sm btn-primary w-100" onclick="checkPassword()">Unlock</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Socket.io -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const socket = io();
        const terminal = document.getElementById('terminal');
        const statusBadges = {
            connected: '<span class="status-dot status-online"></span>Connected',
            disconnected: '<span class="status-dot status-offline"></span>Disconnected'
        };

        // --- Chart.js Setup ---
        const chartConfig = (color) => ({
            type: 'line',
            data: {
                labels: Array(20).fill(''),
                datasets: [{
                    data: Array(20).fill(null),
                    borderColor: color,
                    borderWidth: 2,
                    tension: 0.4,
                    pointRadius: 0,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: false },
                    y: { display: false, beginAtZero: true }
                },
                animation: false
            }
        });

        const multiChartConfig = (color1, color2) => ({
            type: 'line',
            data: {
                labels: Array(20).fill(''),
                datasets: [
                    { data: Array(20).fill(null), borderColor: color1, borderWidth: 2, tension: 0.4, pointRadius: 0 },
                    { data: Array(20).fill(null), borderColor: color2, borderWidth: 2, tension: 0.4, pointRadius: 0 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: false },
                    y: { display: false, beginAtZero: true }
                },
                animation: false
            }
        });

        // Initialize Charts
        const ctxQueued = document.getElementById('chart-queued').getContext('2d');
        const chartQueued = new Chart(ctxQueued, chartConfig('#d1d5db')); // Light Grey

        const ctxTotal = document.getElementById('chart-total').getContext('2d');
        const chartTotal = new Chart(ctxTotal, chartConfig('#ffc107')); // Warning/Yellow

        const ctxRate = document.getElementById('chart-rate').getContext('2d');
        const chartRate = new Chart(ctxRate, multiChartConfig('#198754', '#0dcaf0')); // Success(Green) and Info(Blue)

        // History Charts
        const histOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: {
                    display: true,
                    ticks: { color: '#6c757d', maxTicksLimit: 6 },
                    grid: { color: '#2c3034' }
                },
                y: {
                    display: true,
                    beginAtZero: true,
                    max: 100,
                    ticks: { color: '#6c757d' },
                    grid: { color: '#2c3034' }
                }
            },
            elements: { point: { radius: 1, backgroundColor: '#fff', hitRadius: 10 } }
        };

        const createHistChart = (id, color) => new Chart(document.getElementById(id).getContext('2d'), {
            type: 'line',
            data: { labels: [], datasets: [{ data: [], borderColor: color, borderWidth: 2, fill: true, backgroundColor: color + '20' }] },
            options: histOptions
        });

        const histCpu = createHistChart('hist-cpu', '#0dcaf0');
        const histRam = createHistChart('hist-ram', '#ffc107');
        const histDisk = createHistChart('hist-disk', '#dc3545');

        function calculateAverage(data) {
            if (!data || data.length === 0) return 0;
            const sum = data.reduce((a, b) => a + b, 0);
            return (sum / data.length).toFixed(1);
        }

        function loadHistory() {
            fetch('/api/stats/history')
                .then(r => r.json())
                .then(d => {
                    const data = d.data || [];
                    const labels = data.map(p => {
                        const d = new Date(p.timestamp);
                        return d.getHours().toString().padStart(2, '0') + ':' + d.getMinutes().toString().padStart(2, '0');
                    });
                    const cpuData = data.map(p => p.cpu);
                    const ramData = data.map(p => p.ram);
                    const diskData = data.map(p => p.disk);

                    // Update Charts
                    histCpu.data.labels = labels;
                    histCpu.data.datasets[0].data = cpuData;
                    histCpu.update();
                    document.getElementById('avg-cpu').innerText = `Avg: ${calculateAverage(cpuData)}%`;

                    histRam.data.labels = labels;
                    histRam.data.datasets[0].data = ramData;
                    histRam.update();
                    document.getElementById('avg-ram').innerText = `Avg: ${calculateAverage(ramData)}%`;

                    histDisk.data.labels = labels;
                    histDisk.data.datasets[0].data = diskData;
                    histDisk.update();
                    document.getElementById('avg-disk').innerText = `Avg: ${calculateAverage(diskData)}%`;
                });
        }
        // Load on startup
        loadHistory();
        // Reload every 5 mins (approx)
        setInterval(loadHistory, 300000);

        function updateChart(chart, val1, val2 = null) {
            // Shift data
            chart.data.datasets[0].data.shift();
            chart.data.datasets[0].data.push(val1);

            if (chart.data.datasets.length > 1 && val2 !== null) {
                chart.data.datasets[1].data.shift();
                chart.data.datasets[1].data.push(val2);
            }
            chart.update();
        }
        // ---------------------

        // Connection Status
        socket.on('connect', () => {
            const el = document.getElementById('connection-status');
            el.className = 'btn btn-outline-success btn-sm';
            el.innerHTML = statusBadges.connected;
            logToTerminal('System: Client connected to server.');
        });

        socket.on('disconnect', () => {
            const el = document.getElementById('connection-status');
            el.className = 'btn btn-outline-warning btn-sm';
            el.innerHTML = statusBadges.disconnected;
            logToTerminal('System: Connection lost.');
        });

        // System Stats Update (Includes RabbitMQ)
        socket.on('system_stats', (data) => {
            // CPU (Just % for now)
            document.getElementById('cpu-val').innerText = data.cpu + '%';
            document.getElementById('cpu-bar').style.width = data.cpu + '%';

            // RAM
            const ramText = `${data.ram}% <small class="text-muted ms-1">(${data.ram_used.toFixed(1)}GB / ${data.ram_total.toFixed(1)}GB)</small>`;
            document.getElementById('ram-val').innerHTML = ramText;
            document.getElementById('ram-bar').style.width = data.ram + '%';

            // Disk
            const diskText = `${data.disk}% <small class="text-muted ms-1">(${data.disk_used.toFixed(1)}GB / ${data.disk_total.toFixed(1)}GB)</small>`;
            document.getElementById('disk-val').innerHTML = diskText;
            document.getElementById('disk-bar').style.width = data.disk + '%';

            // Net
            document.getElementById('net-in').innerText = data.net_in.toFixed(1);
            document.getElementById('net-out').innerText = data.net_out.toFixed(1);

            // RabbitMQ
            if (data.rabbitmq) {
                const mq = data.rabbitmq;
                const mqStatusEl = document.getElementById('mq-status');

                if (mq.status === 'online') {
                    mqStatusEl.innerHTML = '<span class="badge bg-success">Online</span>';
                    document.getElementById('mq-queued').innerText = mq.messages_ready.toLocaleString();
                    document.getElementById('mq-total').innerText = mq.messages_total.toLocaleString();
                    document.getElementById('mq-rate-in').innerText = mq.publish_rate.toFixed(1);
                    document.getElementById('mq-rate-out').innerText = mq.deliver_rate.toFixed(1);

                    // Update Graphs
                    updateChart(chartQueued, mq.messages_ready);
                    updateChart(chartTotal, mq.messages_total);
                    updateChart(chartRate, mq.publish_rate, mq.deliver_rate);
                } else {
                    mqStatusEl.innerHTML = `<span class="badge bg-danger">Offline (${mq.error || 'Err'})</span>`;
                }
            }
        });

        // Container Status Update (Badges in Controls Tab)
        socket.on('status_update', (data) => {
            for (const [key, status] of Object.entries(data)) {
                const el = document.getElementById(`status-${key}`);
                if (el) {
                    if (status === 'running') {
                        el.className = 'badge bg-success ms-2';
                        el.innerText = 'Running';
                    } else {
                        el.className = 'badge bg-danger ms-2';
                        el.innerText = 'Stopped';
                    }
                }
            }
        });

        // Running Containers List Update
        socket.on('container_list', (data) => {
            const tbody = document.getElementById('containers-table-body');
            tbody.innerHTML = '';
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No running containers found.</td></tr>';
                return;
            }

            data.forEach(c => {
                const row = `<tr>
                <td class="text-info font-monospace">${c.id}</td>
                <td class="fw-bold">${c.name}</td>
                <td class="text-muted small">${c.image}</td>
                <td><span class="badge bg-success">${c.status}</span></td>
                <td>${c.uptime}</td>
            </tr>`;
                tbody.innerHTML += row;
            });
        });

        // Command Output Streaming
        socket.on('command_output', (data) => {
            logToTerminal(data.line);
        });

        function logToTerminal(text) {
            const line = document.createElement('div');
            line.textContent = text;
            terminal.appendChild(line);
            terminal.scrollTop = terminal.scrollHeight;
        }

        function clearTerminal() {
            terminal.innerHTML = '<div class="text-muted">// Console cleared</div>';
        }

        // Actions
        function sendAction(type, action, targetName = null) {
            let msg = `Requesting: Docker Compose ${action.toUpperCase()} for ${type}`;
            if (targetName) msg += ` (${targetName})`;
            logToTerminal(msg + '...');

            socket.emit('docker_action', {
                type: type,
                action: action,
                target_name: targetName
            });
        }
        let currentUnlockIndex = null;
        const passwordModal = new bootstrap.Modal(document.getElementById('passwordModal'));

        function loadConfig(name, index) {
            const arrow = document.getElementById(`arrow-${index}`);
            if (arrow.classList.contains('bi-chevron-right')) {
                arrow.classList.remove('bi-chevron-right');
                arrow.classList.add('bi-chevron-down');

                // Fetch config
                fetch(`/api/connector/${name}/config`)
                    .then(r => r.json())
                    .then(data => {
                        if (data.content) {
                            document.getElementById(`editor-${index}`).value = data.content;
                        } else {
                            document.getElementById(`editor-${index}`).value = '// Error loading file';
                        }
                    });
            } else {
                arrow.classList.remove('bi-chevron-down');
                arrow.classList.add('bi-chevron-right');
            }
        }

        function unlockConfig(index, name) {
            // Check if Stopped
            const statusBadge = document.getElementById(`status-connector_${name}`);
            if (statusBadge && statusBadge.innerText.toLowerCase() === 'running') {
                alert('You must STOP the connector before editing the configuration.');
                return;
            }

            currentUnlockIndex = index;
            document.getElementById('unlock-password').value = '';
            document.getElementById('password-error').innerText = '';
            passwordModal.show();
        }

        function checkPassword() {
            const pwd = document.getElementById('unlock-password').value;
            if (pwd === 'P@ssw0rd') {
                passwordModal.hide();
                // Enable Editor
                const index = currentUnlockIndex;
                const editor = document.getElementById(`editor-${index}`);
                editor.readOnly = false;
                editor.style.borderColor = '#ffc107'; // Yellow border to indicate edit mode

                // Toggle Buttons
                document.getElementById(`btn-lock-${index}`).classList.add('d-none');
                document.getElementById(`btn-save-${index}`).classList.remove('d-none');

            } else {
                document.getElementById('password-error').innerText = 'Incorrect password.';
            }
        }

        function saveConfig(name, index) {
            const content = document.getElementById(`editor-${index}`).value;
            const msgEl = document.getElementById(`editor-msg-${index}`);

            msgEl.innerText = 'Saving...';

            fetch(`/api/connector/${name}/config`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: content })
            })
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'success') {
                        msgEl.className = 'text-success small';
                        msgEl.innerText = `Saved! Backup created: ${data.backup}`;

                        // Reset UI
                        document.getElementById(`editor-${index}`).readOnly = true;
                        document.getElementById(`editor-${index}`).style.borderColor = '';
                        document.getElementById(`btn-lock-${index}`).classList.remove('d-none');
                        document.getElementById(`btn-save-${index}`).classList.add('d-none');
                        document.getElementById(`btn-lock-${index}`).innerHTML = '<i class="bi bi-lock-fill"></i> Unlock'; // Reset text if needed
                    } else {
                        msgEl.className = 'text-danger small';
                        msgEl.innerText = data.error || 'Save failed';
                    }
                })
                .catch(err => {
                    msgEl.className = 'text-danger small';
                    msgEl.innerText = 'Network error during save';
                });
        }

        // --- Dynamic Connector Discovery ---
        socket.on('known_connectors', (list) => {
            const container = document.getElementById('connectors-list');
            const loading = document.getElementById('connectors-loading');
            if (loading) loading.remove();

            // list: [{name: 'foo', has_config: true}, ...]

            // 1. Mark all existing cards
            const existingNames = new Set();
            const cards = container.querySelectorAll('.connector-card-col');
            cards.forEach(card => {
                existingNames.add(card.getAttribute('data-name'));
            });

            // 2. Add New Cards
            list.forEach((item, index) => {
                if (!existingNames.has(item.name)) {
                    // Create new
                    const uid = item.name.replace(/[^a-zA-Z0-9]/g, '_'); // Safe ID
                    const html = createConnectorHtml(item.name, item.has_config, uid);
                    container.insertAdjacentHTML('beforeend', html);
                } else {
                    // Update validity status if changed? 
                    // Complex to handle "gaining config" without destroy, maybe just live with refresh for that edge case
                    // or check text content. For now, we assume simple validity state.

                    // Actually, if it changes from invalid to valid, we DO want to replace UI.
                    // Let's check attribute.
                    const existingCard = container.querySelector(`.connector-card-col[data-name="${item.name}"]`);
                    const wasValid = existingCard.getAttribute('data-valid') === 'true';

                    if (wasValid !== item.has_config) {
                        // State changed, replace entire card
                        const uid = item.name.replace(/[^a-zA-Z0-9]/g, '_');
                        const html = createConnectorHtml(item.name, item.has_config, uid);
                        existingCard.outerHTML = html;
                    }
                }
            });

            // 3. Remove Deleted Cards
            const newNames = new Set(list.map(i => i.name));
            cards.forEach(card => {
                const n = card.getAttribute('data-name');
                if (!newNames.has(n)) {
                    card.remove();
                }
            });

            // 4. Handle Empty State
            if (list.length === 0 && document.getElementById('connectors-list').children.length === 0) {
                document.getElementById('connectors-list').innerHTML = '<div class="col-12 text-center text-muted p-3">No connectors found.</div>';
            }
        });

        function createConnectorHtml(name, hasConfig, uid) {
            if (!hasConfig) {
                return `<div class="col-12 connector-card-col" data-name="${name}" data-valid="false">
                    <div class="card border-secondary text-muted">
                        <div class="card-body py-2">
                             <div class="d-flex align-items-center">
                                <i class="bi bi-folder text-secondary me-2"></i> 
                                <strong>${name}</strong>
                                <span class="badge bg-danger ms-2" style="font-size: 0.7em;">No docker-compose found</span>
                            </div>
                        </div>
                    </div>
                 </div>`;
            }

            return `<div class="col-12 connector-card-col" data-name="${name}" data-valid="true">
                <div class="card border-secondary">
                    <div class="card-body d-flex justify-content-between align-items-center py-2">
                        <div class="d-flex align-items-center">
                            <button class="btn btn-sm btn-link text-light text-decoration-none p-0 me-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapseConfig${uid}" aria-expanded="false" aria-controls="collapseConfig${uid}" onclick="loadConfig('${name}', '${uid}')">
                                <i class="bi bi-chevron-right" id="arrow-${uid}"></i>
                            </button>
                            <i class="bi bi-plug-fill text-info me-2"></i> 
                            <strong>${name}</strong>
                            <span id="status-connector_${name}" class="badge bg-secondary ms-2" style="font-size: 0.7em;">Checking...</span>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="sendAction('connector', 'up', '${name}')">Start</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="sendAction('connector', 'down', '${name}')">Stop</button>
                        </div>
                    </div>
                    <!-- Config Editor Accordion -->
                    <div class="collapse" id="collapseConfig${uid}">
                        <div class="card-footer border-secondary bg-darker">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted"><i class="bi bi-file-earmark-code"></i> docker-compose.yml</small>
                                <div>
                                    <button class="btn btn-sm btn-outline-warning" id="btn-lock-${uid}" onclick="unlockConfig('${uid}', '${name}')"><i class="bi bi-lock-fill"></i> Unlock</button>
                                    <button class="btn btn-sm btn-primary d-none" id="btn-save-${uid}" onclick="saveConfig('${name}', '${uid}')"><i class="bi bi-save"></i> Save</button>
                                </div>
                            </div>
                            <textarea class="form-control font-monospace mb-2" id="editor-${uid}" rows="10" style="background-color: #0d1117; color: #c9d1d9; font-size: 0.85em;" readonly></textarea>
                            <div id="editor-msg-${uid}" class="text-danger small"></div>
                        </div>
                    </div>
                </div>
            </div>`;
        }
    </script>
</body>

</html>