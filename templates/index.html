<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenCTI Manager</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #1a1d20;
            color: #d1d5db;
        }

        .card {
            background-color: #212529;
            border-color: #374151;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .terminal-window {
            background-color: #0d1117;
            color: #58a6ff;
            font-family: 'Courier New', Courier, monospace;
            height: 400px;
            overflow-y: auto;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 10px;
            white-space: pre-wrap;
            font-size: 0.9em;
        }

        .status-dot {
            height: 10px;
            width: 10px;
            background-color: #bbb;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-online {
            background-color: #2ea043;
        }

        .status-offline {
            background-color: #da3633;
        }

        /* Custom scrollbar for terminal */
        .terminal-window::-webkit-scrollbar {
            width: 10px;
        }

        .terminal-window::-webkit-scrollbar-track {
            background: #0d1117;
        }

        .terminal-window::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 5px;
        }

        .progress {
            background-color: #374151;
        }
    </style>
</head>

<body class="p-4">

    <div class="container-fluid" style="max-width: 1400px;">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-shield-lock-fill text-primary"></i> OpenCTI Manager</h1>
            <div>
                <span id="connection-status" class="badge bg-secondary"><span
                        class="status-dot"></span>Connecting...</span>
            </div>
        </div>

        <!-- System Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card p-3">
                    <label>CPU Usage <span id="cpu-val" class="float-end">0%</span></label>
                    <div class="progress mt-2" style="height: 10px;">
                        <div id="cpu-bar" class="progress-bar bg-danger" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3">
                    <label>RAM Usage <span id="ram-val" class="float-end">0%</span></label>
                    <div class="progress mt-2" style="height: 10px;">
                        <div id="ram-bar" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3">
                    <label>Disk Usage <span id="disk-val" class="float-end">0%</span></label>
                    <div class="progress mt-2" style="height: 10px;">
                        <div id="disk-bar" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3">
                    <label>Network Sent/Recv</label>
                    <div class="d-flex justify-content-between mt-1">
                        <small class="text-muted">Down: <span id="net-in">0</span> KB/s</small>
                        <small class="text-muted">Up: <span id="net-out">0</span> KB/s</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Control Panel -->
            <div class="col-md-6">
                <h4 class="mb-3">Deployment Management</h4>

                <!-- Core Platform -->
                <div class="card mb-3">
                    <div
                        class="card-header fw-bold text-uppercase text-light border-secondary d-flex justify-content-between">
                        <span><i class="bi bi-hdd-stack"></i> Core Platform</span>
                        <span id="status-core" class="badge bg-secondary">Checking...</span>
                    </div>
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <strong>~/opencti/docker</strong>
                            <div class="text-muted small mt-1">Main OpenCTI Stack</div>
                        </div>
                        <div>
                            <button class="btn btn-success me-2" onclick="sendAction('core', 'up')"><i
                                    class="bi bi-play-fill"></i> Start</button>
                            <button class="btn btn-danger" onclick="sendAction('core', 'down')"><i
                                    class="bi bi-stop-fill"></i> Stop</button>
                        </div>
                    </div>
                </div>

                <!-- Connectors -->
                <h5 class="mt-4 mb-3">Connectors <button class="btn btn-sm btn-outline-secondary float-end"
                        onclick="location.reload()"><i class="bi bi-arrow-clockwise"></i> Refresh</button></h5>
                <div class="row g-3" id="connectors-list">
                    <!-- Connectors will be loaded here by backend -->
                    {% for connector in connectors %}
                    <div class="col-12">
                        <div class="card border-secondary">
                            <div class="card-body d-flex justify-content-between align-items-center py-2">
                                <div>
                                    <i class="bi bi-plug-fill text-info me-2"></i>
                                    <strong>{{ connector }}</strong>
                                    <span id="status-connector_{{ connector }}" class="badge bg-secondary ms-2"
                                        style="font-size: 0.7em;">Checking...</span>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-success me-1"
                                        onclick="sendAction('connector', 'up', '{{ connector }}')">Start</button>
                                    <button class="btn btn-sm btn-outline-danger"
                                        onclick="sendAction('connector', 'down', '{{ connector }}')">Stop</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="col-12 text-center text-muted p-3">No connectors found in ~/opencti/connectors/</div>
                    {% endfor %}
                </div>
            </div>

            <!-- Terminal Output -->
            <div class="col-md-6">
                <h4 class="mb-3">Live Log Console <small class="text-muted fs-6 fw-normal">(Streams Output)</small></h4>
                <div id="terminal" class="terminal-window">
                    <div class="text-muted">// Ready for commands...</div>
                </div>
                <div class="mt-2 text-end">
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearTerminal()">Clear Console</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Socket.io -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const socket = io();
        const terminal = document.getElementById('terminal');
        const statusBadges = {
            connected: '<span class="status-dot status-online"></span>Connected',
            disconnected: '<span class="status-dot status-offline"></span>Disconnected'
        };

        // Connection Status
        socket.on('connect', () => {
            const el = document.getElementById('connection-status');
            el.className = 'badge bg-success';
            el.innerHTML = statusBadges.connected;
            logToTerminal('System: Client connected to server.');
        });

        socket.on('disconnect', () => {
            const el = document.getElementById('connection-status');
            el.className = 'badge bg-danger';
            el.innerHTML = statusBadges.disconnected;
            logToTerminal('System: Connection lost.');
        });

        // System Stats Update
        socket.on('system_stats', (data) => {
            // CPU
            document.getElementById('cpu-val').innerText = data.cpu + '%';
            document.getElementById('cpu-bar').style.width = data.cpu + '%';

            // RAM
            document.getElementById('ram-val').innerText = data.ram + '%';
            document.getElementById('ram-bar').style.width = data.ram + '%';

            // Disk
            document.getElementById('disk-val').innerText = data.disk + '%';
            document.getElementById('disk-bar').style.width = data.disk + '%';

            // Net
            document.getElementById('net-in').innerText = data.net_in.toFixed(1);
            document.getElementById('net-out').innerText = data.net_out.toFixed(1);
        });

        // Container Status Update
        socket.on('status_update', (data) => {
            // data: { 'core': 'running'|'stopped', 'connector_X': 'running'|'stopped' }
            for (const [key, status] of Object.entries(data)) {
                const el = document.getElementById(`status-${key}`);
                if (el) {
                    if (status === 'running') {
                        el.className = 'badge bg-success ms-2';
                        el.innerText = 'Running';
                    } else {
                        el.className = 'badge bg-danger ms-2';
                        el.innerText = 'Stopped';
                    }
                }
            }
        });

        // Command Output Streaming
        socket.on('command_output', (data) => {
            logToTerminal(data.line);
        });

        function logToTerminal(text) {
            const line = document.createElement('div');
            line.textContent = text;
            terminal.appendChild(line);
            terminal.scrollTop = terminal.scrollHeight;
        }

        function clearTerminal() {
            terminal.innerHTML = '<div class="text-muted">// Console cleared</div>';
        }

        // Actions
        function sendAction(type, action, targetName = null) {
            let msg = `Requesting: Docker Compose ${action.toUpperCase()} for ${type}`;
            if (targetName) msg += ` (${targetName})`;
            logToTerminal(msg + '...');

            socket.emit('docker_action', {
                type: type,
                action: action,
                target_name: targetName
            });
        }
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>